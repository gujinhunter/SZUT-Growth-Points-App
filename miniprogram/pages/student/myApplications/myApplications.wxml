<view class="container">
  <view class="title">我的申请记录</view>

  <block wx:if="{{applications.length > 0}}">
    <block wx:for="{{applications}}" wx:key="_id" wx:for-index="appIndex">
      <view class="card">
        <view class="row">
          <text class="label">项目：</text>
          <text>{{item.projectName}}</text>
        </view>
        <view class="row">
          <text class="label">申请时间：</text>
          <text>{{item.createTimeFormatted}}</text>
        </view>
        <view class="row" wx:if="{{item.pointsText !== undefined}}">
          <text class="label">申请积分：</text>
          <text>{{item.pointsText}} 点</text>
        </view>
        <view class="row">
          <text class="label">状态：</text>
          <text class="status {{item.statusClass}}">{{item.status}}</text>
        </view>
        <view class="row">
          <text class="label">申请理由：</text>
          <text>{{item.reason}}</text>
        </view>
        <view wx:if="{{item.fileIDs.length}}" class="row attachments">
          <text class="label">附件：</text>
          <text class="file-link"
                bindtap="previewFile"
                data-appindex="{{appIndex}}">
            查看附件（{{item.fileIDs.length}} 个）
          </text>
        </view>
        <view wx:if="{{item.status === '已驳回' && item.rejectRemark}}" class="row">
          <text class="label">驳回说明：</text>
          <text class="reject-text">{{item.rejectRemark}}</text>
        </view>
        <view wx:if="{{item.rejectHistoryFormatted && item.rejectHistoryFormatted.length}}" class="row history-row">
          <text class="label">驳回历史：</text>
          <view class="history-list">
            <block wx:for="{{item.rejectHistoryFormatted}}" wx:key="idx" wx:for-item="history">
              <view class="history-item">
                <text class="history-time">{{history.timeFormatted || '—'}}</text>
                <text class="history-dot">·</text>
                <text class="history-remark">{{history.remark || '无驳回说明'}}</text>
              </view>
            </block>
          </view>
        </view>
        <view wx:if="{{item.status === '已驳回'}}" class="resubmit-toolbar">
          <view class="resubmit-text">
            <view class="resubmit-title">申请已被驳回</view>
            <view class="resubmit-sub">按要求调整内容后，可再次提交审核</view>
          </view>
          <button class="resubmit-btn"
                  size="mini"
                  bindtap="handleResubmit"
                  data-id="{{item._id}}"
                  data-projectid="{{item.projectId}}"
                  data-projectname="{{item.projectName}}">
            修改后重新提交
          </button>
        </view>
      </view>
    </block>
  </block>

  <view wx:else class="empty">
    暂无申请记录
  </view>
</view>
